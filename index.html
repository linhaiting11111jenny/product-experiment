<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>商品浏览实验</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f5f5;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        /* 商品信息区 */
        .product-section {
            background: white;
            padding: 30px;
            margin-bottom: 20px;
            border-radius: 4px;
            display: flex;
            align-items: flex-start;
            gap: 40px;
        }

        .product-image {
            flex: 1;
            border: 1px solid #eee;
            border-radius: 8px;
            overflow: hidden;
            flex-shrink: 0;
            max-width: 400px;
        }

        .product-image-placeholder {
            width: 100%;
            height: 400px;
            background: #f9f9f9;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 14px;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
        }

        .product-info {
            flex: 1;
        }

        .product-name {
            font-size: 24px;
            font-weight: 500;
            margin-bottom: 8px;
            color: #333;
        }

        .product-category {
            color: #666;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .product-price {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 24px;
            color: #333;
        }

        .product-details-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            line-height: 2;
        }

        .product-details-table tr {
            border-bottom: 1px solid #eee;
        }

        .product-details-table td {
            padding: 8px 0;
        }

        .product-details-table td:first-child {
            color: #888;
            width: 100px;
        }

        .product-details-table tr:last-child td {
            padding: 10px 0;
        }

        /* 评论摘要区 */
        .summary-section {
            background: #f0f0f0;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 4px;
        }

        .summary-title {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 15px;
            color: #ffa500;
        }

        .rating-summary {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stars {
            color: #ffa500;
            font-size: 18px;
        }

        .rating-count {
            color: #666;
            font-size: 14px;
        }

        /* 星级分布图样式（rating条件） */
        .rating-distribution {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .rating-overview {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .rating-stars-display {
            color: #ffa500;
            font-size: 18px;
            line-height: 1;
        }

        .rating-average {
            font-size: 16px;
            font-weight: 500;
            color: #333;
        }

        .rating-total {
            font-size: 14px;
            color: #666;
        }

        .rating-breakdown {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 5px;
        }

        .rating-bar-row {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
        }

        .rating-bar-label {
            width: 35px;
            color: #666;
            text-align: left;
            flex-shrink: 0;
        }

        .rating-bar-container {
            flex: 1;
            height: 16px;
            background-color: #e0e0e0;
            border-radius: 2px;
            overflow: hidden;
            position: relative;
        }

        .rating-bar-fill {
            height: 100%;
            background-color: #ffa500;
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        .rating-bar-percentage {
            width: 40px;
            color: #666;
            text-align: right;
            flex-shrink: 0;
            font-size: 13px;
        }

        .aigrs-text {
            color: #333;
            font-size: 14px;
            line-height: 1.8;
        }

        /* 新增样式示例：支持更多实验条件 */
        .aigrs-negative-text {
            color: #666;
            /* 可以添加更多样式，如不同的颜色、字体等 */
        }

        .detailed-rating {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .rating-breakdown {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .breakdown-item {
            font-size: 13px;
            color: #666;
            padding: 5px 10px;
            background: #f9f9f9;
            border-radius: 3px;
        }

        /* 操作按钮区 */
        .action-section {
            text-align: center;
            margin-bottom: 20px;
        }

        .btn-primary {
            background: #6c757d;
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-primary:hover {
            background: #5a6268;
        }

        .btn-primary:active {
            background: #545b62;
        }

        /* 原始评论区 */
        .reviews-section {
            display: none;
            background: white;
            padding: 30px;
            margin-bottom: 20px;
            border-radius: 4px;
        }

        .reviews-section.active {
            display: block;
        }

        .reviews-title {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 20px;
            color: #ffa500;
        }

        .review-item {
            padding: 20px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .review-item:last-child {
            border-bottom: none;
        }

        .review-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .review-stars {
            color: #ffa500;
            font-size: 14px;
        }

        .review-title {
            font-weight: 500;
            font-size: 15px;
            color: #333;
        }

        .review-content {
            color: #666;
            font-size: 14px;
            line-height: 1.6;
            margin-top: 8px;
        }

        .load-more-section {
            text-align: center;
            margin-top: 20px;
        }

        .btn-load-more {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 25px;
            font-size: 14px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-load-more:hover {
            background: #5a6268;
        }

        .btn-load-more:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* 返回问卷按钮 */
        .return-section {
            text-align: center;
            margin-top: 40px;
            padding-bottom: 40px;
        }

        .btn-return {
            background: #6c757d;
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-return:hover {
            background: #5a6268;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <!-- ① 商品信息区 -->
    <section class="product-section">
        <div class="product-image">
            <img 
                src="E:\3researchcode\713B16LCrGL._AC_SL1500_.jpg" 
                alt="AceTrack G1 智能运动手表" 
                style="width: 100%; height: auto; border-radius: 8px;"
            >
        </div>
        <div class="product-info">
            <h1 class="product-name">AceTrack G1 智能运动手表</h1>
            <p class="product-category">分类：数字穿戴设备 / 实验型号：G1-2026</p>
            <div class="product-price">零售参考价：¥499.00</div>
            <table class="product-details-table">
                <tr>
                    <td>显示屏</td>
                    <td>1.43" AMOLED 视网膜屏 (466×466 px)</td>
                </tr>
                <tr>
                    <td>传感器</td>
                    <td>六轴加速度计、PPG心率传感器、红外血氧监测</td>
                </tr>
                <tr>
                    <td>卫星定位</td>
                    <td>独立双频五星定位 (GPS, GLONASS, Beidou等)</td>
                </tr>
                <tr>
                    <td>防水等级</td>
                    <td>5ATM (支持50米游泳深度)</td>
                </tr>
                <tr>
                    <td>电池续航</td>
                    <td>常规模式：14天 / 重度运动模式：5天</td>
                </tr>
                <tr>
                    <td>连接协议</td>
                    <td>Bluetooth 5.3 / NFC (支持校园模拟卡)</td>
                </tr>
                <tr>
                    <td>运动模式</td>
                    <td>包含操场跑、高强度间歇训练(HIIT)等117种模式</td>
                </tr>
            </table>
        </div>
    </section>

    <!-- ② 评分 & 评论摘要区 -->
    <section class="summary-section" id="summarySection">
        <div class="summary-title">用户评论摘要</div>
        <div id="summaryContent">
            <!-- 这里会根据实验条件动态显示内容 -->
        </div>
    </section>

    <!-- ③ 操作按钮区 -->
    <section class="action-section">
        <button class="btn-primary" id="viewReviewsBtn">查看原始评论</button>
    </section>

    <!-- ④ 原始评论区 -->
    <section class="reviews-section" id="reviewsSection">
        <div class="reviews-title">用户评论</div>
        <div id="reviewsContainer"></div>
        <div class="load-more-section">
            <button class="btn-load-more" id="loadMoreBtn">加载更多评论</button>
        </div>
    </section>

    <!-- ⑤ 返回问卷按钮 -->
    <section class="return-section">
        <button class="btn-return" id="returnBtn">完成浏览，返回问卷</button>
    </section>

    
    <script>
        // 实验数据存储
        const experimentData = {
            // 问卷和用户标识
            survey_id: null,        // 问卷ID（从URL参数获取）
            user_id: null,          // 用户ID（从URL参数获取，可选）
            respondent_id: null,    // 受访者ID（从URL参数获取，可选）
            
            // 实验条件
            condition: null,        // 将从URL参数获取
            
            // 时间戳记录
            link_click_time: null,        // 点击链接进入页面的时间戳（从URL参数获取或记录）
            page_load_time: null,          // 页面开始加载的时间戳
            page_load_complete_time: null,  // 页面加载完成的时间戳
            dom_content_loaded_time: null,  // DOM内容加载完成的时间戳
            
            // 交互行为记录
            view_reviews: false,           // 是否点击了"查看原始评论"
            click_view_reviews: null,       // 点击"查看原始评论"的时间戳
            reviews_expanded_time: null,    // 评论展开完成的时间戳
            
            // 加载更多行为记录
            click_load_more: [],           // 每次点击"加载更多评论"的记录数组
            total_load_more_clicks: 0,      // 总共点击"加载更多"的次数
            
            // 页面停留时间
            page_leave_time: null,         // 离开页面的时间戳（如果可检测）
            
            // 滚动行为（可选）
            scroll_events: [],              // 滚动事件记录（可选，如果启用）
            
            // 其他行为
            return_click_time: null         // 点击"完成浏览，返回问卷"的时间戳
        };

        // 评论数据池
        const allReviews = [
            { stars: 5, title: "音质很棒", content: "音质清晰，低音效果不错。续航能力也很强，一天使用完全没问题。佩戴舒适，长时间使用不会感到不适。" },
            { stars: 4, title: "性价比高", content: "价格合理，功能齐全。降噪效果一般，但在安静环境下使用足够。续航表现中规中矩，大约8小时左右。" },
            { stars: 5, title: "非常满意", content: "蓝牙连接稳定，没有断连问题。音质超出预期，特别是人声部分。舒适度很好，运动时也不会掉落。" },
            { stars: 3, title: "一般般", content: "续航没有宣传的那么长，实际使用大概6-7小时。音质还可以，但降噪功能效果不明显。佩戴还算舒适。" },
            { stars: 4, title: "值得购买", content: "整体表现不错，续航能力符合预期。音质清晰，低音效果可以。功能齐全，操作简单。舒适度一般，长时间佩戴会有点累。" },
            { stars: 5, title: "超出预期", content: "音质非常好，特别是高音部分。续航能力很强，连续使用10小时没问题。降噪效果明显，在嘈杂环境中也能清晰听音乐。" },
            { stars: 2, title: "不太满意", content: "续航时间太短，只有5-6小时。音质一般，低音不够。佩戴不够舒适，耳朵会疼。降噪功能基本没用。" },
            { stars: 4, title: "还不错", content: "价格合适，音质对得起这个价位。续航表现正常，大约8小时。功能齐全，蓝牙连接稳定。舒适度还可以。" },
            { stars: 5, title: "推荐购买", content: "音质出色，特别是人声和乐器分离度很好。续航能力很强，一天使用完全够用。降噪效果不错，能有效减少环境噪音。" },
            { stars: 3, title: "中规中矩", content: "音质还可以，但不算突出。续航时间一般，大约7小时。降噪功能效果有限。佩戴舒适度中等，长时间使用会有点不适。" },
            { stars: 4, title: "性价比不错", content: "在这个价位算是很不错的了。音质清晰，续航能力符合预期。功能齐全，操作方便。舒适度还可以，但不如高端产品。" },
            { stars: 5, title: "非常推荐", content: "音质很棒，低音有力，高音清晰。续航能力超强，连续使用12小时没问题。降噪效果明显，在飞机上也能安静听音乐。" },
            { stars: 4, title: "满意", content: "整体表现不错，音质清晰，续航能力正常。降噪功能有效，但不如专业降噪耳机。佩戴舒适，适合长时间使用。" },
            { stars: 3, title: "一般", content: "音质还可以，但低音不够。续航时间大约7小时，不算太长。降噪效果一般。舒适度中等，长时间佩戴会累。" },
            { stars: 5, title: "物超所值", content: "音质非常好，特别是人声部分很清晰。续航能力很强，一天使用完全没问题。降噪效果不错，能有效减少噪音干扰。" },
            { stars: 4, title: "值得一试", content: "音质清晰，低音效果可以。续航表现正常，大约8-9小时。功能齐全，蓝牙连接稳定。舒适度还可以，但不如入耳式舒适。" },
            { stars: 2, title: "不推荐", content: "续航时间太短，只有5小时左右。音质一般，低音不够。降噪功能基本没用。佩戴不够舒适，耳朵会疼。" },
            { stars: 4, title: "还可以", content: "价格合理，音质对得起这个价位。续航能力正常，大约8小时。功能齐全，操作简单。舒适度一般。" },
            { stars: 5, title: "很棒", content: "音质出色，特别是高音和低音分离度很好。续航能力很强，连续使用10小时没问题。降噪效果明显，能有效减少环境噪音。" },
            { stars: 3, title: "普通", content: "音质还可以，但不算突出。续航时间一般，大约7小时。降噪功能效果有限。佩戴舒适度中等。" },
            { stars: 4, title: "不错", content: "整体表现不错，音质清晰，续航能力符合预期。功能齐全，蓝牙连接稳定。舒适度还可以，适合日常使用。" },
            { stars: 5, title: "非常满意", content: "音质很棒，低音有力，高音清晰。续航能力超强，连续使用12小时没问题。降噪效果明显，在嘈杂环境中也能清晰听音乐。" },
            { stars: 4, title: "推荐", content: "音质清晰，低音效果可以。续航表现正常，大约8-9小时。功能齐全，操作方便。舒适度还可以。" },
            { stars: 3, title: "一般般", content: "音质还可以，但低音不够。续航时间大约7小时，不算太长。降噪效果一般。舒适度中等。" },
            { stars: 5, title: "物超所值", content: "音质非常好，特别是人声部分很清晰。续航能力很强，一天使用完全没问题。降噪效果不错，能有效减少噪音干扰。" },
            { stars: 4, title: "值得购买", content: "整体表现不错，音质清晰，续航能力正常。降噪功能有效，但不如专业降噪耳机。佩戴舒适，适合长时间使用。" },
            { stars: 2, title: "不太满意", content: "续航时间太短，只有5-6小时。音质一般，低音不够。降噪功能基本没用。佩戴不够舒适。" },
            { stars: 4, title: "还可以", content: "价格合理，音质对得起这个价位。续航能力正常，大约8小时。功能齐全，操作简单。舒适度一般。" },
            { stars: 5, title: "很棒", content: "音质出色，特别是高音和低音分离度很好。续航能力很强，连续使用10小时没问题。降噪效果明显。" },
            { stars: 3, title: "中规中矩", content: "音质还可以，但不算突出。续航时间一般，大约7小时。降噪功能效果有限。佩戴舒适度中等，长时间使用会有点不适。" },
            { stars: 4, title: "不错", content: "整体表现不错，音质清晰，续航能力符合预期。功能齐全，蓝牙连接稳定。舒适度还可以，适合日常使用。" },
            { stars: 5, title: "非常推荐", content: "音质很棒，低音有力，高音清晰。续航能力超强，连续使用12小时没问题。降噪效果明显，在飞机上也能安静听音乐。" },
            { stars: 4, title: "满意", content: "音质清晰，低音效果可以。续航表现正常，大约8-9小时。功能齐全，操作方便。舒适度还可以。" },
            { stars: 3, title: "一般", content: "音质还可以，但低音不够。续航时间大约7小时，不算太长。降噪效果一般。舒适度中等，长时间佩戴会累。" },
            { stars: 5, title: "物超所值", content: "音质非常好，特别是人声部分很清晰。续航能力很强，一天使用完全没问题。降噪效果不错，能有效减少噪音干扰。" },
            { stars: 4, title: "值得一试", content: "音质清晰，低音效果可以。续航表现正常，大约8-9小时。功能齐全，蓝牙连接稳定。舒适度还可以，但不如入耳式舒适。" },
            { stars: 2, title: "不推荐", content: "续航时间太短，只有5小时左右。音质一般，低音不够。降噪功能基本没用。佩戴不够舒适，耳朵会疼。" },
            { stars: 4, title: "还可以", content: "价格合理，音质对得起这个价位。续航能力正常，大约8小时。功能齐全，操作简单。舒适度一般。" },
            { stars: 5, title: "很棒", content: "音质出色，特别是高音和低音分离度很好。续航能力很强，连续使用10小时没问题。降噪效果明显，能有效减少环境噪音。" },
            { stars: 3, title: "普通", content: "音质还可以，但不算突出。续航时间一般，大约7小时。降噪功能效果有限。佩戴舒适度中等。" }
        ];

        // 从URL获取实验条件
        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        // 初始化：获取URL参数并保存问卷ID等信息
        function initExperimentData() {
            // 记录页面开始加载时间
            experimentData.page_load_time = new Date().toISOString();
            
            // 获取问卷ID（支持多种参数名）
            experimentData.survey_id = getUrlParameter('survey_id') || 
                                      getUrlParameter('surveyId') || 
                                      getUrlParameter('survey') ||
                                      getUrlParameter('id') ||
                                      null;
            
            // 获取用户ID（可选）
            experimentData.user_id = getUrlParameter('user_id') || 
                                    getUrlParameter('userId') || 
                                    getUrlParameter('user') ||
                                    null;
            
            // 获取受访者ID（可选）
            experimentData.respondent_id = getUrlParameter('respondent_id') || 
                                          getUrlParameter('respondentId') || 
                                          getUrlParameter('respondent') ||
                                          null;
            
            // 获取实验条件
            experimentData.condition = getUrlParameter('condition') || 'rating';
            
            // 记录点击链接的时间（如果URL中有传递）
            const linkClickTime = getUrlParameter('link_click_time');
            if (linkClickTime) {
                experimentData.link_click_time = linkClickTime;
            } else {
                // 如果没有传递，记录当前时间作为点击时间
                experimentData.link_click_time = experimentData.page_load_time;
            }
        }

        // 初始化评论摘要（根据实验条件）
        // 修改说明：
        // 1. 修改现有条件：直接修改对应条件内的 innerHTML 内容
        // 2. 添加新条件：在 else if 后添加新的条件判断
        // 3. 添加新样式：在 <style> 标签中添加对应的 CSS 类
        function initSummary() {
            const condition = experimentData.condition;
            const summaryContent = document.getElementById('summaryContent');

            if (condition === 'rating') {
                // 条件1：星级分布图（类似Amazon风格）
                // 数据：可以根据实际需要修改百分比
                const ratingData = {
                    average: 4.3,        // 平均评分
                    total: 156,          // 总评论数
                    distribution: [      // 各星级占比（从5星到1星）
                        { stars: 5, percentage: 65 },  // 5星占65%
                        { stars: 4, percentage: 20 },  // 4星占20%
                        { stars: 3, percentage: 8 },   // 3星占8%
                        { stars: 2, percentage: 4 },   // 2星占4%
                        { stars: 1, percentage: 3 }    // 1星占3%
                    ]
                };
                
                // 生成星级显示（4.3分显示为4个完整星 + 1个空星）
                const fullStars = Math.floor(ratingData.average);
                const emptyStars = 5 - fullStars;
                let starsDisplay = '★'.repeat(fullStars) + '☆'.repeat(emptyStars);
                
                // 生成分布条形图HTML
                let distributionHTML = '';
                ratingData.distribution.forEach(item => {
                    distributionHTML += `
                        <div class="rating-bar-row">
                            <div class="rating-bar-label">${item.stars}星</div>
                            <div class="rating-bar-container">
                                <div class="rating-bar-fill" style="width: ${item.percentage}%"></div>
                            </div>
                            <div class="rating-bar-percentage">${item.percentage}%</div>
                        </div>
                    `;
                });
                
                summaryContent.innerHTML = `
                    <div class="rating-distribution">
                        <div class="rating-overview">
                            <div class="rating-stars-display">${starsDisplay}</div>
                            <div class="rating-average">${ratingData.average} out of 5</div>
                            <div class="rating-total">${ratingData.total} 条评论</div>
                        </div>
                        <div class="rating-breakdown">
                            ${distributionHTML}
                        </div>
                    </div>
                `;
            } else if (condition === 'aigrs_neutral') {
                // 条件2：AIGRS 中立版本
                // 修改示例：可以修改文本内容、添加更多段落等
                summaryContent.innerHTML = `
                    <div class="aigrs-text">
                        用户评论显示，该产品在音质、续航和舒适度方面表现稳定。部分用户对降噪功能有不同看法，整体评价较为均衡。
                    </div>
                `;
            } else if (condition === 'aigrs_positive') {
                // 条件3：AIGRS 正向版本
                // 修改示例：可以修改文本内容，使其更积极正面
                summaryContent.innerHTML = `
                    <div class="aigrs-text">
                        用户评论显示，该产品在音质、续航和舒适度方面获得较多好评。大部分用户对产品整体表现表示满意，认为性价比较高。
                    </div>
                `;
            } else if (condition === 'aigrs_negative') {
                // 示例：添加新的实验条件（AIGRS 负向版本）
                // 注意：需要在CSS中添加 .aigrs-negative-text 样式类
                summaryContent.innerHTML = `
                    <div class="aigrs-text aigrs-negative-text">
                        用户评论显示，该产品在某些方面存在不足。部分用户反馈续航时间未达预期，降噪效果有待提升。
                    </div>
                `;
            } else if (condition === 'detailed_rating') {
                // 示例：添加详细评分条件（星级 + 各维度评分）
                summaryContent.innerHTML = `
                    <div class="detailed-rating">
                        <div class="rating-summary">
                            <div class="stars">★★★★☆</div>
                            <div class="rating-count">共 156 条评论</div>
                        </div>
                        <div class="rating-breakdown">
                            <div class="breakdown-item">音质：4.5分</div>
                            <div class="breakdown-item">续航：4.2分</div>
                            <div class="breakdown-item">舒适度：4.3分</div>
                        </div>
                    </div>
                `;
            } else {
                // 默认情况：如果条件不匹配，显示默认内容
                summaryContent.innerHTML = `
                    <div class="rating-summary">
                        <div class="stars">★★★★☆</div>
                        <div class="rating-count">共 156 条评论</div>
                    </div>
                `;
            }
        }

        // 渲染评论
        function renderReviews(startIndex, count) {
            const container = document.getElementById('reviewsContainer');
            const endIndex = Math.min(startIndex + count, allReviews.length);
            
            for (let i = startIndex; i < endIndex; i++) {
                const review = allReviews[i];
                const reviewElement = document.createElement('div');
                reviewElement.className = 'review-item';
                
                const stars = '★'.repeat(review.stars) + '☆'.repeat(5 - review.stars);
                
                reviewElement.innerHTML = `
                    <div class="review-header">
                        <div class="review-stars">${stars}</div>
                        <div class="review-title">${review.title}</div>
                    </div>
                    <div class="review-content">${review.content}</div>
                `;
                
                container.appendChild(reviewElement);
            }
            
            return endIndex;
        }

        // 当前显示的评论数量
        let currentReviewIndex = 0;
        const reviewsPerLoad = 9;
        const maxLoads = 5;
        let loadCount = 0;

        // 查看原始评论按钮
        document.getElementById('viewReviewsBtn').addEventListener('click', function() {
            if (!experimentData.view_reviews) {
                experimentData.view_reviews = true;
                experimentData.click_view_reviews = new Date().toISOString();
                
                // 显示评论区
                document.getElementById('reviewsSection').classList.add('active');
                
                // 首次加载评论
                currentReviewIndex = renderReviews(0, reviewsPerLoad);
                loadCount = 1;
                
                // 记录评论展开完成时间（使用setTimeout确保DOM更新完成）
                setTimeout(function() {
                    experimentData.reviews_expanded_time = new Date().toISOString();
                }, 100);
                
                // 隐藏查看按钮
                this.style.display = 'none';
            }
        });

        // 加载更多评论按钮
        document.getElementById('loadMoreBtn').addEventListener('click', function() {
            if (loadCount < maxLoads) {
                const timestamp = new Date().toISOString();
                experimentData.click_load_more.push({
                    count: loadCount + 1,
                    timestamp: timestamp,
                    before_scroll_position: window.scrollY || window.pageYOffset
                });
                
                currentReviewIndex = renderReviews(currentReviewIndex, reviewsPerLoad);
                loadCount++;
                experimentData.total_load_more_clicks = loadCount;
                
                // 记录加载完成后的滚动位置
                setTimeout(function() {
                    const lastRecord = experimentData.click_load_more[experimentData.click_load_more.length - 1];
                    if (lastRecord) {
                        lastRecord.after_scroll_position = window.scrollY || window.pageYOffset;
                        lastRecord.load_complete_time = new Date().toISOString();
                    }
                }, 100);
                
                if (loadCount >= maxLoads) {
                    this.disabled = true;
                    this.textContent = '已加载全部评论';
                }
            }
        });

        // 检测是否在iframe中
        function isInIframe() {
            try {
                return window.self !== window.top;
            } catch (e) {
                return true;
            }
        }

        // 检查URL是否有效（不是模板变量）
        function isValidUrl(url) {
            if (!url || typeof url !== 'string') return false;
            const trimmed = url.trim();
            // 检查是否是空字符串
            if (trimmed === '') return false;
            // 检查是否包含模板变量（如{{}}）
            if (trimmed.includes('{{') && trimmed.includes('}}')) return false;
            // 检查是否是有效的URL格式
            try {
                const urlObj = new URL(trimmed);
                return urlObj.protocol === 'http:' || urlObj.protocol === 'https:';
            } catch (e) {
                return false;
            }
        }

        // 向父窗口发送数据（用于Credamo平台）
        function sendDataToParent(data) {
            if (isInIframe() && window.parent) {
                // 通过postMessage发送数据给Credamo（始终发送）
                window.parent.postMessage({
                    type: 'experiment_complete',
                    data: data
                }, '*');
                
                // 如果Credamo支持URL跳转，也可以通过URL参数传递
                const returnUrl = getUrlParameter('return_url');
                if (isValidUrl(returnUrl)) {
                    // URL有效，尝试跳转
                    try {
                        // 将数据编码到URL参数中
                        const params = new URLSearchParams();
                        params.set('experiment_data', JSON.stringify(data));
                        const separator = returnUrl.includes('?') ? '&' : '?';
                        const fullUrl = returnUrl + separator + params.toString();
                        
                        // 在iframe中，需要跳转整个页面，而不是只跳转iframe
                        // 使用window.top来跳转整个窗口
                        if (window.top && window.top !== window.self) {
                            window.top.location.href = fullUrl;
                        } else {
                            window.location.href = fullUrl;
                        }
                    } catch (e) {
                        console.error('跳转失败：', e);
                        console.log('数据已通过postMessage发送，请确保Credamo页面已配置接收postMessage');
                    }
                } else {
                    // URL无效或未提供，只使用postMessage
                    console.log('return_url参数无效或未提供，数据已通过postMessage发送');
                    console.log('请在Credamo的下一个页面中通过postMessage接收数据');
                }
            }
        }

        // 返回问卷按钮
		document.getElementById('returnBtn').addEventListener('click', function () {
		    const endTime = Date.now();
		    const startTime = new Date(experimentData.page_load_time).getTime();
		    const staySeconds = Math.round((endTime - startTime) / 1000);
		    const returnUrl = getUrlParameter('return_url');
		    
		    // 1. 拼接回传参数（对应见数的「输出型变量」）
		    const params = new URLSearchParams();
		    params.set('condition', experimentData.condition); // 实验条件
		    params.set('view_reviews', experimentData.view_reviews ? 1 : 0); // 是否看评论
		    params.set('load_more_cnt', experimentData.total_load_more_clicks || 0); // 加载次数
		    params.set('stay_time', staySeconds); // 停留时间
		    
		    // 2. 拼接返回URL（关键：跳回见数，且携带数据）
		    const fullUrl = returnUrl + (returnUrl.includes('?') ? '&' : '?') + params.toString();
		
		    // 3. 适配见数iframe：用top.location跳转（避免只刷新iframe）
		    if (window.top) {
		        window.top.location.href = fullUrl;
		    } else {
		        window.location.href = fullUrl;
		    }
		    
		    // 4. 额外：通过postMessage向见数父页面发送数据（双重保障）
		    if (window.parent) {
		        window.parent.postMessage({
		            type: 'experiment_data',
		            data: {
		                condition: experimentData.condition,
		                view_reviews: experimentData.view_reviews,
		                load_more_cnt: experimentData.total_load_more_clicks,
		                stay_time: staySeconds
		            }
		        }, '*');
		    }
		});


        // 页面加载完成事件
        window.addEventListener('load', function() {
            experimentData.page_load_complete_time = new Date().toISOString();
        });
        
        // DOM内容加载完成事件
        window.addEventListener('DOMContentLoaded', function() {
            experimentData.dom_content_loaded_time = new Date().toISOString();
            initExperimentData();  // 先初始化实验数据（获取问卷ID等）
            initSummary();         // 再初始化评论摘要
        });
        
        // 页面离开前保存数据（可选）
        window.addEventListener('beforeunload', function() {
            experimentData.page_leave_time = new Date().toISOString();
            // 可以在这里再次保存数据
        });
    </script>
</body>
</html>

